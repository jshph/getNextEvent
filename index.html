<html>
<head>
  <link href='http://fonts.googleapis.com/css?family=Roboto' rel='stylesheet' type='text/css'>
  <style>
    body {
      font-family: 'Roboto', sans-serif;
    }

    p {
      -webkit-margin-before: 0px;
      -webkit-margin-after: 0px;
      -webkit-margin-start: 0px;
      -webkit-margin-end: 0px;
    }

    #eventsToday, #eventsUpcoming {
      margin-bottom: 15px;
      display:block;
    }

    .detail {
      padding-top:10px;
      padding-bottom: 15px;
      color:gray;
    }

    .eventElem {
      padding: 7px;
      width:400px;
      padding-left: 15px;
      cursor:pointer;
      position:relative;
      overflow:auto;
    }

    .eventElem:hover {
      background-color: rgb(252, 213, 142);
    }

    .info_cont {
      color: gray;
      text-align: left;
      display: block;
    }

    .title {
      padding-right: 40px;
    }

    .time, .location, .title {
      color:gray;
      font-size: 14px;
      display: inline-block;
    }

    .location {
      display:none;
    }

    .desc {
      display:none;
      background-color: rgb(230, 230, 230);
      padding:14px;
      margin-top:15px;
      margin-bottom:7px;
      line-height: 1.3em;
      cursor:default;
    }

    .arrow {
      /*right: 20;*/
      position:absolute;
      margin: auto;
      margin-left:350px;
      top:0;
      bottom: 0;
      cursor:pointer;
      display:none;
      z-index:5;
      opacity: .6;
    }

    .arrow:hover {
      opacity:1;
    }

    .active > .info_cont {
      display: inline-block;
    }

    .active > .desc {
      display:block;
    }
    
    .eventElem:hover .location, .eventElem:hover:not(.active) .arrow {
      display:block;
    }

    .active > .title {
      color:black;
      display: inline-block;
      padding-left: 0px;
      font-size: 16px;
    }

    .active .arrow {
      display:none;
    }

    .active {
      border-left: solid rgb(160, 203, 238) 10px;
    }

    
  </style>
  <script src="//ajax.googleapis.com/ajax/libs/jquery/1.11.1/jquery.min.js"></script>
  <script>
    var mykey = 'AIzaSyB0XHfSOtB46ACNHAFtWRHai5cordII94E';
    var calendarid = 'lh7f9qf4fld1kblm14b988e5ek@group.calendar.google.com';

    var sortedEvents = {};

    function makeRequest(howSoon, callback) {
      var newDate = new Date();

      // temporary event filter only lists events in the next day. Ideally, it should list events until a quota of events (3) is met to fill out the widget.

      var url = 'https://www.googleapis.com/calendar/v3/calendars/' + calendarid + '/events?'
      + 'key=' + mykey
      + '&orderBy=startTime'
      + '&singleEvents=true'
      + '&maxResults=5';
      if (howSoon === 'today') {
        url += '&timeMin=' + newDate.toISOString();
        newDate.setDate(newDate.getDate() + 1);
        url += '&timeMax=' + newDate.toISOString();
      }
      else if (howSoon === 'upcoming') {
        newDate.setDate(newDate.getDate() + 1);
        url += '&timeMin=' + newDate.toISOString();
      }

      $.ajax({
          type: 'GET',
          url: encodeURI(url),
          dataType: 'json',
          success: function (response) {
              callback(response.items, howSoon);
          },
          error: function (response) {
              console.log(response); //error!
          }
      });
    }


    // functions for later use ///////////////

    function convertISODate(ISOString) {
      var date = new Date(ISOString);
      return date;
    }


    // handles date object and returns a text string consisting of time of day in 12 hour, AM/PM format.
    function convertToTime(date) {
      var timeString;
      var afternoon = false;

      if (date.getHours() >= 12)
        afternoon = true;

      timeString = afternoon ? date.getHours() - 12 : date.getHours();
      timeString = timeString == 0 ? 12 : timeString;
      timeString += ":";
      timeString += ( date.getMinutes() % 100 == 0 ) ? "0" + date.getMinutes() : date.getMinutes();
      timeString += " ";
      timeString += afternoon ? "PM" : "AM";
      return timeString;
    }

    // generates string date.
    function generateDate(date) {
      return (date.getMonth() + 1) + '/' + date.getDate();
    }

    function processEvent(calEvent, isToday, receptorID) {
      // display to view
      $('#events' + receptorID).append($(generateElement(calEvent, isToday)));

      if ($(receptorID).children().length === 1)
        $(receptorID).append("<p>No events scheduled!</p>");

      sortEvent(calEvent);
    }

    function sortEvent(calEvent) {
      var key = calEvent.summary
      if (!(key in sortedEvents)) {
        // init
        sortedEvents[key] = {
          'desc': calEvent.description,
          'times': new Array()
        };
      };
      sortedEvents[key].times.push(calEvent.start.dateTime);
    }

    // encapsulate generation of single event element, return DOM object.
    function generateElement(calEvent, isToday) {
        // Construct container for each event.
        // eventCont > linkify > info_cont > info_time + info_location
      var startTime = convertISODate(calEvent.start.dateTime);
      var dateString = convertToTime(startTime) + " - " + convertToTime(convertISODate(calEvent.end.dateTime));
      if (!isToday) dateString += " on " + generateDate(startTime);

      var eventElement = document.createElement('div');
      $(eventElement).addClass('eventElem');

      var info_title = document.createElement('div');
      $(info_title).addClass("title")
                    .text(calEvent.summary)
                    .appendTo($(eventElement));

      // contains details.
      var info_cont = document.createElement('div');
      $(info_cont).addClass('info_cont')
                  .appendTo(eventElement);

      var info_time = document.createElement('p');
      $(info_time).addClass('time')
                  .text(dateString)
                  .appendTo($(info_cont));

      var info_desc = document.createElement('p');
      $(info_desc).addClass('desc')
                  .text(calEvent.description)
                  .appendTo($(eventElement));

      if (calEvent.location) {
        var info_location = document.createElement('p');
        $(info_location).addClass('location')
                        .text(calEvent.location)
                        .appendTo($(info_cont));
      }
      
      var arrow = document.createElement('img')
      $(arrow).attr({
                src: "http://dental.anatomage.com/images/mdstudio/right-normal.png",
                width: 17
              })
              .addClass('arrow')
              .appendTo($(eventElement));

      var linkify = document.createElement('a');
      $(eventElement).appendTo(linkify);


      return eventElement;
    }

    // populate calendar. THIS IS WHERE ALL DA MAGIC HAPPEN ///////////////
    function manageFill(eventList, receptorID) {
      var today = new Date();

      if (receptorID === 'today') var isToday = true;
      else if (receptorID === 'upcoming') var isToday = false;

      eventList.forEach(function(calEvent) {processEvent(calEvent, isToday, receptorID);});
      console.log(sortedEvents);
    }

    function listenForNav() {

      $('.eventElem').click(function() {
        console.log('clicked');
        $(this).addClass('active');
        $('.eventElem').not($(this)).removeClass('active');
      });

    }

    makeRequest('today', manageFill);
    makeRequest('upcoming', manageFill);

  </script>
  <script src="https://apis.google.com/js/client.js?onload=load"></script>
</head>
<body>
  <div class="mainContainer">
    <div id="eventstoday"><h3>Today</h3></div>
    <div id="eventsupcoming"><h3>Upcoming</h3></div>
  </div>
   <!--  <button onclick="load();">click to login</button> -->
</body>
</html>